<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Vote App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f3f4f6; }
        
        /* Hide Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-active { border-bottom: 3px solid #f97316; color: #ea580c; font-weight: bold; }
        .card-selected { border: 2px solid #22c55e; background-color: #f0fdf4; }
        
        .menu-card { transition: all 0.2s ease-in-out; }
        .menu-card:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-24">

    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-4 shadow-lg sticky top-0 z-40">
        <h1 class="text-xl font-bold text-center">üçΩÔ∏è Vote ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</h1>
        <p class="text-sm text-center text-orange-100 mt-1" id="user-display">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <div id="app" class="max-w-md mx-auto p-4 hidden">
        
        <div id="status-message" class="hidden text-center mt-6 p-6 bg-white rounded-xl shadow-lg"></div>

        <div id="voting-form">
            <div class="sticky top-20 z-30 bg-gray-50 pt-2 pb-4">
                <div class="flex overflow-x-auto gap-3 py-1 scrollbar-hide px-1" id="category-tabs">
                    </div>
            </div>

            <div id="menu-container" class="grid grid-cols-1 gap-4 mt-2">
                </div>

            <div class="fixed bottom-0 left-0 w-full bg-white p-4 border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
                <div class="max-w-md mx-auto">
                    <button id="submit-btn" onclick="submitVote()" 
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Vote</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURATION
        // ==========================================
        const LIFF_ID = "2008873864-VbOip62x";       
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxm_8hlDz4fjyEhOWVe4V0_Wy9nGnBwKaVVUV3vZwcLlB3_bB_QCUXJbtna5fEBazBISg/exec"; 
        // ==========================================

        let profile = null;
        let menuData = {};
        let selections = {}; 
        let currentCategory = "";
        let isEditMode = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

        // --- MAIN FUNCTION ---
        async function main() {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                profile = await liff.getProfile();
                document.getElementById('user-display').innerText = `‡∏ú‡∏π‡πâ‡πÇ‡∏´‡∏ß‡∏ï: ${profile.displayName}`;

                const response = await fetch(`${GAS_URL}?op=getData&userId=${profile.userId}`);
                const data = await response.json();
                
                Swal.close(); 

                if (data.status === 'open') {
                    document.getElementById('app').classList.remove('hidden');
                    menuData = data.menus;

                    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Edit Mode Check)
                    if (data.previousSelections) {
                        isEditMode = true;
                        selections = data.previousSelections;
                        
                        // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        const btn = document.getElementById('submit-btn');
                        btn.innerHTML = `<span>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>`;
                        btn.className = "w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2";
                        
                        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ
                        const Toast = Swal.mixin({
                            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                        });
                        Toast.fire({ icon: 'info', title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' });
                    }

                    // 2. ‡πÅ‡∏™‡∏î‡∏á Welcome Alert
                    await Swal.fire({
                        title: `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${profile.displayName}`,
                        html: `
                            <div class="text-left mt-2">
                                <p class="mb-3 text-gray-600">‡∏£‡πà‡∏ß‡∏° Vote ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2569</p>
                                <ul class="text-sm text-gray-700 space-y-2 list-disc pl-5 bg-orange-50 p-4 rounded-lg border border-orange-100">
                                    <li>‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <b>1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</li>
                                    <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î <b>2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î</li>
                                    <li>‡∏õ‡∏¥‡∏î Vote: <span class="text-red-500 font-bold">${data.closeTimeFormatted || '-'}</span></li>
                                </ul>
                            </div>
                        `,
                        imageUrl: profile.pictureUrl,
                        imageWidth: 80,
                        imageHeight: 80,
                        imageAlt: 'Profile',
                        // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°
                        customClass: {
                            image: 'rounded-full border-4 border-orange-200 shadow-sm object-cover'
                        },
                        confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö / ‡πÄ‡∏£‡∏¥‡πà‡∏° Vote',
                        confirmButtonColor: '#f97316',
                        allowOutsideClick: false
                    });

                    renderTabs();
                    switchCategory(Object.keys(menuData)[0]);

                } else if (data.status === 'closed') {
                    document.getElementById('app').classList.remove('hidden');
                    showClosedResults(data.results);
                }

            } catch (err) {
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message });
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderTabs() {
            const container = document.getElementById('category-tabs');
            container.innerHTML = Object.keys(menuData).map(cat => `
                <button onclick="switchCategory('${cat}')" 
                    class="tab-btn px-5 py-2 whitespace-nowrap bg-white rounded-full shadow-sm text-gray-600 text-sm transition font-medium border border-transparent hover:border-orange-200" 
                    id="tab-${cat}">
                    ${cat}
                </button>
            `).join('');
        }

        function switchCategory(cat) {
            currentCategory = cat;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-orange-500', 'text-white', 'shadow-md');
                btn.classList.add('bg-white', 'text-gray-600');
            });
            const activeTab = document.getElementById(`tab-${cat}`);
            if(activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-600');
                activeTab.classList.add('bg-orange-500', 'text-white', 'shadow-md');
            }

            const list = menuData[cat];
            const container = document.getElementById('menu-container');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (!list || list.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 py-20 flex flex-col items-center"><span class="text-4xl mb-2">üçΩÔ∏è</span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>`;
                return;
            }

            container.innerHTML = list.map((item, index) => {
                const isSelected = (selections[cat] || []).includes(item.name);
                return `
                <div onclick="toggleSelect('${item.name}')" 
                     class="menu-card cursor-pointer bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between ${isSelected ? 'card-selected' : ''}"
                     id="card-${index}">
                    <div class="pr-4">
                        <h3 class="font-bold text-gray-800 text-lg">${item.name}</h3>
                        <p class="text-sm text-gray-500 mt-1">${item.desc || ''}</p>
                    </div>
                    <div class="flex-shrink-0 h-8 w-8 rounded-full border-2 border-gray-200 flex items-center justify-center transition-colors ${isSelected ? 'bg-green-500 border-green-500' : 'bg-gray-50'}">
                        ${isSelected ? '<span class="text-white font-bold">‚úì</span>' : ''}
                    </div>
                </div>
            `}).join('');
        }

        function toggleSelect(itemName) {
            if (!selections[currentCategory]) selections[currentCategory] = [];
            
            const list = selections[currentCategory];
            const index = list.indexOf(itemName);

            if (index > -1) {
                list.splice(index, 1); 
            } else {
                if (list.length >= 2) {
                    Swal.fire({
                        icon: 'warning',
                        title: '‡πÄ‡∏ï‡πá‡∏°‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤',
                        text: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    return;
                }
                list.push(itemName);
            }
            switchCategory(currentCategory); 
        }

        // --- SUBMIT FUNCTION ---
        async function submitVote() {
            // Validation Logic
            const allCategories = Object.keys(menuData);
            const missingCategories = [];

            allCategories.forEach(cat => {
                if (menuData[cat] && menuData[cat].length > 0) {
                    const selectedInCat = selections[cat];
                    if (!selectedInCat || selectedInCat.length === 0) {
                        missingCategories.push(cat);
                    }
                }
            });

            if (missingCategories.length > 0) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö',
                    html: `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î:<br><br><span class="text-red-500 font-bold bg-red-50 px-2 py-1 rounded">${missingCategories.join(', ')}</span>`,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#f97316'
                });
                return;
            }

            // ----------------------------------------------------
            // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (SweetAlert) ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ isEditMode
            // ----------------------------------------------------
            let alertTitle, alertText, alertIcon, confirmColor, confirmTextBtn;

            if (isEditMode) {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                alertTitle = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?';
                alertText = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ';
                alertIcon = 'info';
                confirmColor = '#3b82f6'; // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤
                confirmTextBtn = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏´‡∏ß‡∏ï‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
                alertTitle = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?';
                alertText = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö';
                alertIcon = 'question';
                confirmColor = '#22c55e'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                confirmTextBtn = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Vote';
            }

            const result = await Swal.fire({
                title: alertTitle,
                text: alertText,
                icon: alertIcon,
                showCancelButton: true,
                confirmButtonText: confirmTextBtn,
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: confirmColor,
                cancelButtonColor: '#d1d5db'
            });
            // ----------------------------------------------------

            if (result.isConfirmed) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                const payload = JSON.stringify({
                    userId: profile.userId,
                    displayName: profile.displayName,
                    selections: selections
                });

                try {
                    const res = await fetch(GAS_URL, {
                        method: 'POST',
                        body: payload
                    });
                    const respData = await res.json();

                    if (respData.status === 'success') {
                        await Swal.fire({
                            icon: 'success',
                            title: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!',
                            text: respData.message,
                            confirmButtonColor: confirmColor
                        });
                        location.reload(); 
                    } else {
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', respData.message, 'error');
                    }
                } catch (error) {
                    Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
                }
            }
        }

        function showClosedResults(results) {
            document.getElementById('voting-form').style.display = 'none';
            const statusDiv = document.getElementById('status-message');
            statusDiv.classList.remove('hidden');
            
            let html = `
                <div class="text-6xl mb-4">üèÜ</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• Vote ‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>
                <p class="text-gray-500 mb-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞‡πÉ‡∏à‡∏Ñ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà</p>
            `;
            
            for (const [cat, data] of Object.entries(results)) {
                html += `
                    <div class="bg-white p-4 rounded-xl mb-4 text-left border-l-4 border-orange-500 shadow-sm">
                        <h3 class="font-bold text-gray-600 text-sm mb-1">${cat}</h3>
                        <div class="flex justify-between items-end">
                            <span class="text-gray-900 font-bold text-lg leading-tight">${data.item}</span>
                            <span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-lg text-xs font-bold whitespace-nowrap ml-2">${data.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                        </div>
                    </div>
                `;
            }
            statusDiv.innerHTML = html;
        }

        main();
    </script>
</body>
</html>
