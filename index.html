<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2569</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 3px solid #f59e0b; color: #d97706; font-weight: bold; }
        .card-selected { border: 2px solid #10b981; background-color: #ecfdf5; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-10">

    <div class="bg-orange-500 text-white p-4 shadow-md sticky top-0 z-50">
        <h1 class="text-xl font-bold text-center">üçΩÔ∏è Vote ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2569</h1>
        <p class="text-sm text-center text-orange-100" id="user-display">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</p>
    </div>

    <div id="app" class="max-w-md mx-auto p-4 hidden">
        
        <div id="status-message" class="hidden text-center mt-10 p-6 bg-white rounded-xl shadow"></div>

        <div id="voting-form">
            <div class="flex overflow-x-auto gap-4 py-2 mb-4 scrollbar-hide" id="category-tabs">
                </div>

            <div id="menu-container" class="grid grid-cols-1 gap-4">
                </div>

            <button onclick="submitVote()" class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform active:scale-95">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï
            </button>
        </div>
    </div>

    <script>
    // --- CONFIG ---
    const LIFF_ID = "2008873864-VbOip62x"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxm_8hlDz4fjyEhOWVe4V0_Wy9nGnBwKaVVUV3vZwcLlB3_bB_QCUXJbtna5fEBazBISg/exec"; 

    let profile = null;
    let menuData = {};
    let selections = {}; 
    let currentCategory = "";

    async function main() {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            profile = await liff.getProfile();
            document.getElementById('user-display').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${profile.displayName}`;

            const response = await fetch(`${GAS_URL}?op=getData&userId=${profile.userId}`);
            const data = await response.json();
            
            Swal.close(); // ‡∏õ‡∏¥‡∏î Loading ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô

            if (data.status === 'open') {
                
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: SweetAlert ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤ ---
                await Swal.fire({
                    title: `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${profile.displayName}`,
                    html: `
                        <div class="text-left mt-2">
                            <p class="mb-2 text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Vote ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2569</p>
                            <p class="mb-2 text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
                            <ul class="text-sm text-gray-700 space-y-2 list-disc pl-5 bg-orange-50 p-4 rounded-lg border border-orange-100">
                                <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ<br><b>‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</b></li>
                                <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ <b>‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ Vote</b> ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:<br><span class="text-red-500 font-bold">${data.closeTimeFormatted}</span></li>
                                <li>‡∏ú‡∏•‡∏Å‡∏≤‡∏£ Vote ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏¥‡∏î Vote</li>
                            </ul>
                        </div>
                    `,
                    imageUrl: profile.pictureUrl, // ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏•‡∏ô‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    imageWidth: 80,
                    imageHeight: 80,
                    imageAlt: 'Profile',
                    confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö / ‡πÄ‡∏£‡∏¥‡πà‡∏° Vote',
                    confirmButtonColor: '#f97316', // ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏ï‡∏≤‡∏°‡∏ò‡∏µ‡∏°
                    allowOutsideClick: false
                });
                // ------------------------------------------------

                menuData = data.menus;
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏´‡∏° (Code ‡πÄ‡∏î‡∏¥‡∏°)
                if (data.previousSelections) {
                    selections = data.previousSelections;
                    // ... (Logic ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                    document.querySelector('#voting-form button').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
                    document.querySelector('#voting-form button').classList.replace('bg-green-500', 'bg-blue-500');
                    document.querySelector('#voting-form button').classList.replace('hover:bg-green-600', 'hover:bg-blue-600');
                }

                document.getElementById('app').classList.remove('hidden');
                renderTabs();
                switchCategory(Object.keys(menuData)[0]);

            } else if (data.status === 'closed') {
                showClosedResults(data.results);
            }
        } catch (err) {
            Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
        }
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ---
    function renderTabs() {
        const container = document.getElementById('category-tabs');
        container.innerHTML = Object.keys(menuData).map(cat => `
            <button onclick="switchCategory('${cat}')" 
                class="tab-btn px-4 py-2 whitespace-nowrap bg-white rounded-full shadow-sm text-gray-600 text-sm transition" 
                id="tab-${cat}">
                ${cat}
            </button>
        `).join('');
    }

    function switchCategory(cat) {
        currentCategory = cat;
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-orange-500', 'text-white');
            btn.classList.add('bg-white', 'text-gray-600');
        });
        const activeTab = document.getElementById(`tab-${cat}`);
        if(activeTab) {
            activeTab.classList.remove('bg-white', 'text-gray-600');
            activeTab.classList.add('bg-orange-500', 'text-white');
        }

        const list = menuData[cat];
        const container = document.getElementById('menu-container');
        
        if (list.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>`;
            return;
        }

        container.innerHTML = list.map((item, index) => {
            const isSelected = (selections[cat] || []).includes(item.name);
            return `
            <div onclick="toggleSelect('${item.name}')" 
                 class="cursor-pointer bg-white p-4 rounded-xl shadow flex items-center justify-between transition ${isSelected ? 'card-selected' : ''}"
                 id="card-${index}">
                <div>
                    <h3 class="font-bold text-gray-800">${item.name}</h3>
                    <p class="text-xs text-gray-500">${item.desc || ''}</p>
                </div>
                <div class="h-6 w-6 rounded-full border-2 border-gray-300 flex items-center justify-center ${isSelected ? 'bg-green-500 border-green-500' : ''}">
                    ${isSelected ? '<span class="text-white text-xs">‚úì</span>' : ''}
                </div>
            </div>
        `}).join('');
    }

    function toggleSelect(itemName) {
        if (!selections[currentCategory]) selections[currentCategory] = [];
        
        const list = selections[currentCategory];
        const index = list.indexOf(itemName);

        if (index > -1) {
            list.splice(index, 1); 
        } else {
            if (list.length >= 2) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
                    text: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö',
                    timer: 1500,
                    showConfirmButton: false
                });
                return;
            }
            list.push(itemName);
        }
        switchCategory(currentCategory);
    }

    async function submitVote() {
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const allCategories = Object.keys(menuData);
            const missingCategories = [];

            allCategories.forEach(cat => {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                if (menuData[cat] && menuData[cat].length > 0) {
                    const selectedInCat = selections[cat];
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô array ‡∏ß‡πà‡∏≤‡∏á
                    if (!selectedInCat || selectedInCat.length === 0) {
                        missingCategories.push(cat);
                    }
                }
            });

            // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î
            if (missingCategories.length > 0) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏¢‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î',
                    html: `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î:<br><span class="text-red-500 font-bold">${missingCategories.join(', ')}</span>`,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            }

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å?',
                text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                const payload = JSON.stringify({
                    userId: profile.userId,
                    displayName: profile.displayName,
                    selections: selections
                });

                try {
                    const res = await fetch(GAS_URL, {
                        method: 'POST',
                        body: payload
                    });
                    const respData = await res.json();

                    if (respData.status === 'success') {
                        await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', respData.message, 'success');
                        location.reload(); 
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', respData.message, 'error');
                    }
                } catch (error) {
                    Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
            }
        }

    function showClosedResults(results) {
        document.getElementById('voting-form').style.display = 'none';
        const statusDiv = document.getElementById('status-message');
        statusDiv.classList.remove('hidden');
        
        let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6">üèÜ ‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>`;
        for (const [cat, data] of Object.entries(results)) {
            html += `
                <div class="bg-orange-50 p-4 rounded-lg mb-4 text-left border border-orange-200">
                    <h3 class="font-bold text-orange-600">${cat}</h3>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-gray-800 text-lg">${data.item}</span>
                        <span class="bg-orange-500 text-white px-2 py-1 rounded text-xs">${data.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                    </div>
                </div>
            `;
        }
        statusDiv.innerHTML = html;
    }

    main();
</script>
</body>
</html>






