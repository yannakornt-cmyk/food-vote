<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 3px solid #f59e0b; color: #d97706; font-weight: bold; }
        .card-selected { border: 2px solid #10b981; background-color: #ecfdf5; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-10">

    <div class="bg-orange-500 text-white p-4 shadow-md sticky top-0 z-50">
        <h1 class="text-xl font-bold text-center">üçΩÔ∏è ‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>
        <p class="text-sm text-center text-orange-100" id="user-display">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</p>
    </div>

    <div id="app" class="max-w-md mx-auto p-4 hidden">
        
        <div id="status-message" class="hidden text-center mt-10 p-6 bg-white rounded-xl shadow"></div>

        <div id="voting-form">
            <div class="flex overflow-x-auto gap-4 py-2 mb-4 scrollbar-hide" id="category-tabs">
                </div>

            <div id="menu-container" class="grid grid-cols-1 gap-4">
                </div>

            <button onclick="submitVote()" class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform active:scale-95">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï
            </button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const LIFF_ID = "2008873864-VbOip62x"; // ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxm_8hlDz4fjyEhOWVe4V0_Wy9nGnBwKaVVUV3vZwcLlB3_bB_QCUXJbtna5fEBazBISg/exec"; // ‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß

        let profile = null;
        let menuData = {};
        let selections = {}; // { "‡πÅ‡∏Å‡∏á‡∏ï‡πâ‡∏°‡∏à‡∏∑‡∏î": ["A", "B"] }
        let currentCategory = "";

        // --- INIT ---
        async function main() {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                profile = await liff.getProfile();
                document.getElementById('user-display').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${profile.displayName}`;

                // Fetch Data from GAS
                const response = await fetch(`${GAS_URL}?op=getData&userId=${profile.userId}`);
                const data = await response.json();
                
                Swal.close();
                document.getElementById('app').classList.remove('hidden');

                if (data.status === 'open') {
                    menuData = data.menus;
                    renderTabs();
                    // Select first category by default
                    switchCategory(Object.keys(menuData)[0]);
                } else if (data.status === 'closed') {
                    showClosedResults(data.results);
                } else if (data.status === 'voted') {
                    showStatusMessage("‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏£‡∏±‡∏ö");
                }

            } catch (err) {
                Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
            }
        }

        // --- RENDER LOGIC ---
        function renderTabs() {
            const container = document.getElementById('category-tabs');
            container.innerHTML = Object.keys(menuData).map(cat => `
                <button onclick="switchCategory('${cat}')" 
                    class="tab-btn px-4 py-2 whitespace-nowrap bg-white rounded-full shadow-sm text-gray-600 text-sm transition" 
                    id="tab-${cat}">
                    ${cat}
                </button>
            `).join('');
        }

        function switchCategory(cat) {
            currentCategory = cat;
            
            // Update Tabs Style
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-orange-500', 'text-white');
                btn.classList.add('bg-white', 'text-gray-600');
            });
            const activeTab = document.getElementById(`tab-${cat}`);
            if(activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-600');
                activeTab.classList.add('bg-orange-500', 'text-white');
            }

            // Render Items
            const list = menuData[cat];
            const container = document.getElementById('menu-container');
            
            if (list.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>`;
                return;
            }

            container.innerHTML = list.map((item, index) => {
                const isSelected = (selections[cat] || []).includes(item.name);
                return `
                <div onclick="toggleSelect('${item.name}')" 
                     class="cursor-pointer bg-white p-4 rounded-xl shadow flex items-center justify-between transition ${isSelected ? 'card-selected' : ''}"
                     id="card-${index}">
                    <div>
                        <h3 class="font-bold text-gray-800">${item.name}</h3>
                        <p class="text-xs text-gray-500">${item.desc || ''}</p>
                    </div>
                    <div class="h-6 w-6 rounded-full border-2 border-gray-300 flex items-center justify-center ${isSelected ? 'bg-green-500 border-green-500' : ''}">
                        ${isSelected ? '<span class="text-white text-xs">‚úì</span>' : ''}
                    </div>
                </div>
            `}).join('');
        }

        function toggleSelect(itemName) {
            if (!selections[currentCategory]) selections[currentCategory] = [];
            
            const list = selections[currentCategory];
            const index = list.indexOf(itemName);

            if (index > -1) {
                list.splice(index, 1); // Deselect
            } else {
                if (list.length >= 2) {
                    Swal.fire({
                        icon: 'warning',
                        title: '‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
                        text: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    return;
                }
                list.push(itemName); // Select
            }
            switchCategory(currentCategory); // Re-render
        }

        async function submitVote() {
            // Check if at least one item is selected
            const totalSelected = Object.values(selections).flat().length;
            if (totalSelected === 0) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
                return;
            }

            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï?',
                text: "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                // Send POST to GAS (Use text/plain to avoid CORS Preflight issues in GAS)
                const payload = JSON.stringify({
                    userId: profile.userId,
                    displayName: profile.displayName,
                    selections: selections
                });

                try {
                    const res = await fetch(GAS_URL, {
                        method: 'POST',
                        body: payload
                    });
                    const respData = await res.json();

                    if (respData.status === 'success') {
                        await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', respData.message, 'success');
                        location.reload(); // Reload to show voted status
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', respData.message, 'error');
                    }
                } catch (error) {
                    Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
            }
        }

        function showStatusMessage(title, subtitle) {
            document.getElementById('voting-form').style.display = 'none';
            const statusDiv = document.getElementById('status-message');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = `
                <div class="text-6xl mb-4">üéâ</div>
                <h2 class="text-2xl font-bold text-gray-800">${title}</h2>
                <p class="text-gray-500 mt-2">${subtitle}</p>
            `;
        }

        function showClosedResults(results) {
            document.getElementById('voting-form').style.display = 'none';
            const statusDiv = document.getElementById('status-message');
            statusDiv.classList.remove('hidden');
            
            let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6">üèÜ ‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>`;
            
            for (const [cat, data] of Object.entries(results)) {
                html += `
                    <div class="bg-orange-50 p-4 rounded-lg mb-4 text-left border border-orange-200">
                        <h3 class="font-bold text-orange-600">${cat}</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-gray-800 text-lg">${data.item}</span>
                            <span class="bg-orange-500 text-white px-2 py-1 rounded text-xs">${data.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                        </div>
                    </div>
                `;
            }
            statusDiv.innerHTML = html;
        }

        // Start
        main();
    </script>
</body>
</html>
