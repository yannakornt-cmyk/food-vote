<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF No Iframe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card p-4 text-center" style="max-width: 400px; width: 100%;">
        
        <div id="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">กำลังยืนยันตัวตน...</p>
        </div>

        <div id="content" class="hidden">
            <img id="uPicture" src="" alt="Profile" class="profile-pic mb-3">
            <h4 id="uName" class="mb-1">Name</h4>
            <p id="uId" class="text-muted small mb-4">ID: ...</p>

            <button onclick="submitData()" id="btnSubmit" class="btn btn-primary w-100 btn-lg mb-2">
                บันทึกข้อมูลเข้า Sheet
            </button>
            <p id="statusMessage" class="mt-3 text-success fw-bold"></p>
        </div>

    </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
    // ================= ตั้งค่าตรงนี้ =================
    const LIFF_ID = "2008873864-VbOip62x";  // ใส่ LIFF ID ของคุณ
    const GAS_API = "https://script.google.com/macros/s/AKfycbxm_8hlDz4fjyEhOWVe4V0_Wy9nGnBwKaVVUV3vZwcLlB3_bB_QCUXJbtna5fEBazBISg/exec"; // ใส่ URL ที่ได้จากการ Deploy GAS (ส่วนที่ 1)
    // ==============================================

    let userProfile = null;

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            const profile = await liff.getProfile();
            userProfile = profile;

            // แสดงผลบนหน้าจอ
            document.getElementById('uPicture').src = profile.pictureUrl || "https://via.placeholder.com/150";
            document.getElementById('uName').innerText = profile.displayName;
            document.getElementById('uId').innerText = "ID: " + profile.userId;

            // สลับการแสดงผล
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

        } catch (err) {
            alert("Error: " + err.message);
        }
    }

    // ฟังก์ชันส่งข้อมูลไป Google Sheet
    function submitData() {
        if (!userProfile) return;

        const btn = document.getElementById('btnSubmit');
        const msg = document.getElementById('statusMessage');
        
        btn.disabled = true;
        btn.innerText = "กำลังบันทึก...";

        // ส่งข้อมูลด้วย fetch (POST)
        fetch(GAS_API, {
            method: 'POST',
            mode: 'no-cors', // สำคัญ: เพื่อไม่ให้ Browser บล็อกการส่งข้ามโดเมน
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                pictureUrl: userProfile.pictureUrl
            })
        }).then(() => {
            // เนื่องจากใช้ mode: no-cors เราจะอ่าน response ไม่ได้ แต่ถือว่าส่งสำเร็จถ้าไม่ error
            msg.innerText = "บันทึกข้อมูลเรียบร้อย!";
            btn.innerText = "สำเร็จ";
            
            // ปิดหน้าต่าง LIFF อัตโนมัติ
            setTimeout(() => {
                liff.closeWindow();
            }, 2000);
        }).catch(err => {
            msg.innerText = "เกิดข้อผิดพลาด";
            msg.style.color = "red";
            btn.disabled = false;
            console.error(err);
        });
    }

    main();
</script>

</body>

</html>

